name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-product:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Test Product Service
        working-directory: ./services/product-service
        run: |
          npm install
          npm test

  test-user:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Test User Service
        working-directory: ./services/user-service
        run: |
          npm install
          npm test

  test-order:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Test Order Service
        working-directory: ./services/order-service
        run: |
          npm install
          npm test
 
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Test Frontend
        working-directory: ./frontend
        run: |
          npm install 
          npm test

  build-and-push:
    needs: [test-product, test-user, test-order, test-frontend]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Quay.io
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login quay.io -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Build and Push Product Service
      run: |
        docker buildx build --push \
        -t quay.io/${{ secrets.QUAY_USERNAME }}/product-service:${{ github.sha }} \
        ./services/product-service

    - name: Build and Push User Service
      run: |
         docker buildx build --push \
         -t quay.io/${{ secrets.QUAY_USERNAME }}/user-service:${{ github.sha }} \
         ./services/user-service

    - name: Build and Push Order Service
      run: |
        docker buildx build --push \
        -t quay.io/${{ secrets.QUAY_USERNAME }}/order-service:${{ github.sha }} \
        ./services/order-service

    - name: Build and Push Frontend
      run: |
        docker buildx build --push \
        -t quay.io/${{ secrets.QUAY_USERNAME }}/frontend:${{ github.sha }} 
        ./frontend

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Update Kubernetes manifests
        run: |
          # Update image tags in k8s/base/product-service.yaml
          # Commit changes to GitOps repo
